#!/bin/bash
################################################################################
# Logging functions
INFO(){ echo -n "INFO: "; echo "$@" ;}
WARN(){ echo -n "WARN: "; echo "$@" ;}
ERRO(){ echo -n "ERRO: "; echo -n "$@" ; echo " Abort!"; exit 1;}

################################################################################
# Check some deps
bin_exist(){
    if command -v "$1" &> /dev/null; then
        INFO "$1 checked"
    else
        ERRO "Missing ${1}!"
    fi
}

bin_exist wine
bin_exist winetricks

################################################################################
# Some vars
export WINEPREFIX WINEARCH WINEDLLOVERRIDES
export PREFIXCOMMAND TMP
export LOL_OpenGL
export LOL_LAUNCHER_NAME LOL_LAUNCHER_ARGS
export LOL_INSTALL_PATH  LOL_LAUNCHER_PATH
export LOL_LAUNCHER_BETA_NAME LOL_LAUNCHER_BETA_ARGS
export LOL_RUN_LOG
export WINE_REQ_MOD

WINEARCH=win32
WINEPREFIX="$HOME/.local/share/leagueoflegends"
PREFIXCOMMAND=""
LOL_OpenGL=2
LOL_RUN_LOG="$WINEPREFIX/wine_lol.log"
LOL_LAUNCHER_NAME="lol.launcher.exe"
LOL_LAUNCHER_BETA_NAME="LeagueClient.exe"
LOL_LAUNCHER_BETA_ARGS="--no-sandbox"
LOL_INSTALL_PATH="$WINEPREFIX/drive_c/LoL/"
WINE_REQ_MOD=( corefonts vcrun2005 vcrun2008 d3dx9 )

TMP="$(mktemp -u)"
################################################################################
# Initialization
CONF=/etc/leagueoflegends.conf
[ ! -f "$CONF" ] && ERRO "Missing: ${CONF}"
INFO "Reading Config"
# shellcheck source=leagueoflegends.conf
source "$CONF"

echo ---
INFO "Check: $WINEPREFIX"
if [ ! -d "$WINEPREFIX" ]; then
    INFO "Wine prefix not exist"
    INFO "So try recreate it"

    wineboot &> /dev/null

    INFO "Make user dirs isolated"
    find -H "$WINEPREFIX/drive_c/users/" -type l -delete

    INFO "Created: $WINEPREFIX"
fi

echo ---
INFO "Last tested version: wine-1.9.23"
INFO "Your version: $(wine --version)"

echo ---
INFO "Check: if configured"
for mod in "${WINE_REQ_MOD[@]}"; do
    [ -z "$mod" ] && continue
    if ! grep -q "$mod" "$WINEPREFIX/winetricks.log"; then
        winetricks -q "$mod" || ERRO "Something went wrong!"
    fi
done

rm_w(){ [ -f "$1" ] && rm "$1"; }

echo ---
reinstall(){
    INFO "Install OLD tiny launcher"
    for file in /opt/leagueoflegends/*.exe; do
        install -Dm644 "$file" "$LOL_INSTALL_PATH/$(basename "$file")" || ERRO "Something went wrong!"
    done
    for file in /opt/leagueoflegends/RADS/system/*; do
        install -Dm644 "$file" "$LOL_INSTALL_PATH/RADS/system/$(basename "$file")" || ERRO "Something went wrong!"
    done
}

INFO "Check if OLD launcher installed"
if [ ! -d "$LOL_INSTALL_PATH" ]; then
    INFO "League of Legends not found at: $LOL_INSTALL_PATH"
    INFO "Try found any launcher"
    find -H "$WINEPREFIX/drive_c/" -name "$LOL_LAUNCHER_NAME" > "$TMP"
    read -r LOL_LAUNCHER_PATH < "$TMP"

    if [ -f "$LOL_LAUNCHER_PATH" ]; then
        INFO "Find another League of Legends launcher, move it to $LOL_INSTALL_PATH"
        dirname "$LOL_LAUNCHER_PATH" > "$TMP"
        read -r LOL_DIR < "$TMP"
        mv -v "$LOL_DIR/" "$LOL_INSTALL_PATH/"
    else
        INFO "League of Legends not found at $WINEPREFIX/drive_c/"
        INFO "So reinstall it"
        # Install Tiny Launcher
        reinstall
    fi
else
    INFO "League of Legends found at: $LOL_INSTALL_PATH"
fi

echo ---
INFO "Try use dlls from LoL installation"
{
    for file in $(find $LOL_INSTALL_PATH -type f -name "*.dll"); do
        basename $file
    done
} | grep .dll | grep -v rcp-be | sort -u > $TMP

for dll in $(cat $TMP); do
    WINEDLLOVERRIDES="$dll=n,b $WINEDLLOVERRIDES"
done
WINEDLLOVERRIDES=${WINEDLLOVERRIDES// /;}

echo ---
INFO "Initialization Finished"

configure_OpenGL(){
    dos2unix(){ sed $'s/\r$//'; }
    unix2dos(){ sed $'s/$/\r/'; }

    LOL_game_cfg=$LOL_INSTALL_PATH/Config/game.cfg
    if [ ! -f "$LOL_game_cfg" ]; then
        INFO "Can't find: $LOL_game_cfg"
        INFO "Ignore OpenGL setting"
        LOL_OpenGL=2
    fi

    case "$LOL_OpenGL" in
        0|1) dos2unix > "$TMP" < "$LOL_game_cfg" ;;
    esac

    case "$LOL_OpenGL" in
        0)
            if grep -q x3d_platform=1 "$LOL_game_cfg"; then
                sed -i 's/x3d_platform=1//g' "$TMP"
                unix2dos > "$LOL_game_cfg" < "$TMP"
                INFO "Disable OpenGL in game.cfg"
            fi
        ;;
        1)
            if ! grep -q x3d_platform=1 "$LOL_game_cfg"; then
                sed -i 's/\[General\]/\[General\]\nx3d_platform=1/g' "$TMP"
                unix2dos > "$LOL_game_cfg" < "$TMP"
                INFO "Enable OpenGL in game.cfg"
            fi
        ;;
    esac
}

{
    echo ---
    case "$1" in
        winecfg)
            winecfg
            echo "winecfg"
        ;;
        wineserver)
            shift;
            wineserver "$@"
            echo "wineserver" "$@"
        ;;
        reinstall)
            reinstall
            echo "reinstall"
        ;;
        regen_wine_prefix)
            INFO "Dir for backup: $LOL_INSTALL_PATH"
            mv -v "$LOL_INSTALL_PATH" "$WINEPREFIX/../LoL/" || ERRO "Can't backup LoL dir"
            rm -rf "$WINEPREFIX"
            INFO "Self rerun to recreate wineprefix"
            "$0" silent
            [ -d "$LOL_INSTALL_PATH" ] && rm -rf "$LOL_INSTALL_PATH"
            mv -v "$WINEPREFIX/../LoL/" "$LOL_INSTALL_PATH"
        ;;
        beta)
            configure_OpenGL
            winepath -w "$LOL_INSTALL_PATH/$LOL_LAUNCHER_BETA_NAME" > "$TMP" 2> /dev/null
            read -r WIN_PATH < "$TMP"

            INFO "LoL Launcher UNIX path: $LOL_INSTALL_PATH/$LOL_LAUNCHER_BETA_NAME"
            INFO "LoL Launcher WINE path: $WIN_PATH"
            INFO "Run: $LOL_LAUNCHER_BETA_NAME" "$LOL_LAUNCHER_BETA_ARGS"
            INFO "Wine run log: $LOL_RUN_LOG"
            $PREFIXCOMMAND wine "$WIN_PATH" "$LOL_LAUNCHER_BETA_ARGS" &>> "$LOL_RUN_LOG"
        ;;
        launcher)
            configure_OpenGL
            winepath -w "$LOL_INSTALL_PATH/$LOL_LAUNCHER_NAME" > "$TMP" 2> /dev/null
            read -r WIN_PATH < "$TMP"

            INFO "LoL Launcher UNIX path: $LOL_INSTALL_PATH/$LOL_LAUNCHER_NAME"
            INFO "LoL Launcher WINE path: $WIN_PATH"
            INFO "Run: $LOL_LAUNCHER_NAME" "$LOL_LAUNCHER_ARGS"
            INFO "Wine run log: $LOL_RUN_LOG"
            $PREFIXCOMMAND wine "$WIN_PATH" "$LOL_LAUNCHER_ARGS" &>> "$LOL_RUN_LOG"
        ;;
        silent) : ;;
        tail) : ;;
        *)
            echo "$0 <no args>  - Initialization of wine prefix with game, also show help"
            echo "$0 silent     - same as <no args> but no help output"
            echo "$0 launcher   - launch lol client"
            echo "$0 beta       - launch lol beta client"
            echo "$0 winecfg    - run winecfg in lol prefix"
            echo "$0 wineserver <args> - -k for killing all processes"
            echo "$0 reinstall  - reinstall lol launcher bins"
            echo "$0 regen_wine_prefix - backup LoL dir, recreate wineprefix, move LoL back, use carefully"
            echo "$0 tail       - tail -f to log file"
        ;;
    esac
    echo ---
} | tee -a "$LOL_RUN_LOG"

# It's prevent problem with recursion in log: tail -f file &>> file
case "$1" in
    tail) tail -f "$LOL_RUN_LOG" ;;
esac

rm_w "$TMP"
