#!/bin/bash
################################################################################
# Logging functions
INFO(){ echo -n "INFO: "; echo "$@" ;}
WARN(){ echo -n "WARN: "; echo "$@" ;}
ERRO(){ echo -n "ERRO: "; echo -n "$@" ; echo " Abort!"; exit 1;}

################################################################################
# Check some deps
bin_exist(){
    if command -v "$1" &> /dev/null; then
        INFO "INFO: $1 checked"
    else
        ERRO "Missing ${1}!"
    fi
}

bin_exist wine
bin_exist winetricks

################################################################################
INFO "Last tested version: wine-1.9.21 (Staging) enabled CSMT"

################################################################################
# Some vars
export WINEPREFIX WINEARCH
export PREFIXCOMMAND LOL_LAUNCHER_NAME LOL_INSTALL_PATH
export LOL_OpenGL

INSTALLER_FILE_NAME="LeagueOfLegendsBaseEUW.exe"
INSTALLER_URL="http://l3cdn.riotgames.com/Installer/SingleFileInstall/$INSTALLER_FILE_NAME"

################################################################################
# Initialization
if [ ! -f /etc/leagueoflegends.conf ]; then
    ERRO "Missing /etc/leagueoflegends.conf !"
fi

. /etc/leagueoflegends.conf

################################################################################
# Status mapping
# 1 - wine configured need to install LoL
# 2 - LoL Installer downloaded
# 3 - LoL Launcher Installed
# 4 - LoL Launcher Placed to Unix friendly path

if [ ! -d "$WINEPREFIX" ]; then
    INFO "Wine prefix not exist"
    INFO "So try reinstall it"
    winetricks -q corefonts vcrun2005 vcrun2008 d3dx9 || ERRO "Something went wrong!"
    INFO "Make user dirs isolated"
    find -H "$WINEPREFIX/drive_c/users/" -type l -delete
    echo 1 > "$WINEPREFIX/STATUS"
    INFO "Created: $WINEPREFIX"
fi

################################################################################
[ -f "$WINEPREFIX/STATUS" ] && read -r STATUS < "$WINEPREFIX/STATUS"

if [ "$STATUS" == "1" ]; then
    wget $INSTALLER_URL -O "$WINEPREFIX/drive_c/$INSTALLER_FILE_NAME" || ERRO "Installer download filed!"
    echo 2 > "$WINEPREFIX/STATUS"
    INFO "LoL Installer downloaded"
fi

################################################################################
[ -f "$WINEPREFIX/STATUS" ] && read -r STATUS < "$WINEPREFIX/STATUS"

if [ "$STATUS" == "2" ]; then
    INFO "Set wine version to Win7 for installing"
    winetricks win7

    wine "C:/$INSTALLER_FILE_NAME" || ERRO "Install fails!"

    INFO "Set wineversion to WinXP as install completed"
    winetricks winxp

    INFO "LoL Installed"
    echo 3 > "$WINEPREFIX/STATUS"
fi

################################################################################
# Check if LoL installed
export LOL_LAUNCHER_PATH

if [ ! -f "$LOL_INSTALL_PATH/$LOL_LAUNCHER_NAME" ]; then
    TMP="$(mktemp)"

    find -H "$WINEPREFIX/drive_c/" -name "$LOL_LAUNCHER_NAME" > "$TMP"
    read -r LOL_LAUNCHER_PATH < "$TMP"

    [ ! -f "$LOL_LAUNCHER_PATH" ] && ERRO "Can't find LoL Launcher!"
    rm "$TMP"
fi

if [ ! -d "$LOL_INSTALL_PATH" ]; then
    WARN "Move LoL dir for remove spaces in path"
    TMP="$(mktemp)"
    dirname "$LOL_LAUNCHER_PATH" > "$TMP"
    read -r LOL_DIR < "$TMP"
    rm "$TMP"

    mv -v "$LOL_DIR/" "$LOL_INSTALL_PATH/"

    echo 4 > "$WINEPREFIX/STATUS"
fi

dos2unix(){ sed $'s/\r$//'; }
unix2dos(){ sed $'s/$/\r/'; }

LOL_game_cfg=$LOL_INSTALL_PATH/Config/game.cfg
if [ ! -f "$LOL_game_cfg" ]; then
    INFO "Ignore OpenGL setting"
    LOL_OpenGL=2
fi

case "$LOL_OpenGL" in
    0)
        if grep -q x3d_platform=1 "$LOL_game_cfg"; then
            TMP="$(mktemp)"
            dos2unix > "$TMP" < "$LOL_game_cfg"
            sed -i 's/x3d_platform=1//g' "$TMP"
            unix2dos > "$LOL_game_cfg" < "$TMP"
            rm "$TMP"
            INFO "Disable OpenGL in game.cfg"
        fi
    ;;
    1)
        if ! grep -q x3d_platform=1 "$LOL_game_cfg"; then
            TMP="$(mktemp)"
            dos2unix > "$TMP" < "$LOL_game_cfg"
            sed -i 's/\[General\]/\[General\]\n x3d_platform=1/g' "$TMP"
            unix2dos > "$LOL_game_cfg" < "$TMP"
            rm "$TMP"
            INFO "Enable OpenGL in game.cfg"
        fi
    ;;
esac

echo ---
TMP="$(mktemp)"
winepath -w "$LOL_INSTALL_PATH/$LOL_LAUNCHER_NAME" > "$TMP"
read -r WIN_PATH < "$TMP"
rm "$TMP"

INFO "LoL Launcher path: $LOL_INSTALL_PATH/$LOL_LAUNCHER_NAME"
INFO "All okay, let's enjoy!"
INFO "Try to run: $LOL_LAUNCHER_NAME"

$PREFIXCOMMAND wine "$WIN_PATH"
